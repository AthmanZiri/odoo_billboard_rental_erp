<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_document_inherit_media" inherit_id="account.report_invoice_document">
        <!-- Add Custom CSS -->
        <xpath expr="//t[@t-call='web.external_layout']" position="inside">
            <style>
                .media-specs {
                    font-size: 0.85rem;
                    color: #555;
                    margin-top: 5px;
                    border-top: 1px solid #eee;
                    padding-top: 5px;
                }
                .media-spec-item {
                    display: block;
                    margin-bottom: 2px;
                }
                .media-spec-label {
                    font-weight: bold;
                }
                .text-red-total, .o_total td:last-child, .o_total td:nth-child(2) {
                    color: #e62117 !important;
                    font-weight: bold;
                }
            </style>
        </xpath>

        <!-- Custom Table Header -->
        <xpath expr="//table[contains(@class, 'o_main_table')]//thead//tr" position="replace">
            <tr>
                <th name="th_item" class="text-start">ITEM</th>
                <th name="th_billboard" class="text-start">Billboard</th>
                <th name="th_priceunit" class="text-end">MONTHLY RATES</th>
                <th name="th_quantity" class="text-end">MONTHS BOOKED</th>
                <th name="th_subtotal" class="text-end">Sub- Total</th>
            </tr>
        </xpath>

        <!-- Custom Table Body -->
        <xpath expr="//table[contains(@class, 'o_main_table')]//tbody" position="replace">
            <tbody class="invoice_tbody">
                <t t-set="current_subtotal" t-value="0"/>
                <t t-foreach="o.invoice_line_ids" t-as="line">
                    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>

                    <tr t-att-class="'bg-200 font-weight-bold o_line_section' if line.display_type == 'line_section' else 'font-italic o_line_note' if line.display_type == 'line_note' else ''">
                        <t t-if="line.display_type == 'product' or not line.display_type">
                            <td name="td_item">
                                <span t-esc="line_index + 1"/>
                            </td>
                            <td name="td_name">
                                <span t-field="line.name" t-options="{'widget': 'text'}"/>
                                <t t-if="line.media_face_id">
                                    <div class="media-specs">
                                        <div class="media-spec-item">
                                            <span class="media-spec-label">Size:</span>
                                            <span t-esc="'%.0fx%.0f' % (line.media_face_id.width, line.media_face_id.height)"/> meters <span t-field="line.media_face_id.orientation"/>
                                        </div>
                                        
                                        <t t-set="billboard" t-value="line.env['media.billboard'].search([('site_id', '=', line.media_face_id.site_id.id)], limit=1)"/>
                                        <t t-if="billboard and billboard.location_text">
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Location:</span>
                                                <span t-esc="billboard.location_text"/>
                                            </div>
                                        </t>
                                        <t t-elif="line.media_face_id.site_id.street or line.media_face_id.site_id.city or line.media_face_id.site_id.county_id">
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Location:</span>
                                                <span t-esc="', '.join([x for x in [line.media_face_id.site_id.street, line.media_face_id.site_id.city, line.media_face_id.site_id.county_id.name] if x])"/>
                                            </div>
                                        </t>
                                        
                                        <t t-if="line.media_face_id.face_type == 'digital'">
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Content size:</span>
                                                (<span t-field="line.media_face_id.content_size_rec"/>)
                                            </div>
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Content type:</span>
                                                <span t-field="line.media_face_id.supported_formats"/>
                                            </div>
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Operating hours:</span>
                                                <t t-set="start_hour" t-value="int(line.media_face_id.operating_hours_start)"/>
                                                <t t-set="start_min" t-value="int((line.media_face_id.operating_hours_start % 1) * 60)"/>
                                                <t t-set="end_hour" t-value="int(line.media_face_id.operating_hours_end)"/>
                                                <t t-set="end_min" t-value="int((line.media_face_id.operating_hours_end % 1) * 60)"/>
                                                <span t-esc="'%02d:%02d' % (start_hour, start_min)"/> to <span t-esc="'%02d:%02d' % (end_hour, end_min)"/>
                                            </div>
                                            <!-- Handle dynamic fields from dummy logic if needed, but for now matching SO report -->
                                            <t t-if="hasattr(line.media_face_id, 'slot_duration')">
                                                <div class="media-spec-item">
                                                    <span class="media-spec-label">Content Duration:</span>
                                                    <span t-field="line.media_face_id.slot_duration"/>sec every <t t-esc="int((line.media_face_id.slot_duration * line.media_face_id.number_of_slots) / 60)"/> min
                                                </div>
                                            </t>
                                            <div class="media-spec-item">
                                                <span t-field="line.media_face_id.views_per_day"/> views per day
                                            </div>
                                            <div class="media-spec-item">
                                                <span class="media-spec-label">Maximum clients:</span>
                                                <span t-field="line.media_face_id.number_of_slots"/>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </td>
                            <td name="td_priceunit" class="text-end">
                                <span t-field="line.price_unit"/>
                            </td>
                            <td name="td_quantity" class="text-end">
                                <span t-field="line.quantity"/>
                                <span t-field="line.product_uom_id"/>
                            </td>
                            <td name="td_subtotal" class="text-end o_price_total">
                                <span t-field="line.price_subtotal"/>
                            </td>
                        </t>
                        <t t-elif="line.display_type == 'line_section'">
                            <td name="td_section_line" colspan="99">
                                <span t-field="line.name" t-options="{'widget': 'text'}"/>
                            </td>
                            <t t-set="current_section" t-value="line"/>
                            <t t-set="current_subtotal" t-value="0"/>
                        </t>
                        <t t-elif="line.display_type == 'line_note'">
                            <td name="td_note_line" colspan="99">
                                <span t-field="line.name" t-options="{'widget': 'text'}"/>
                            </td>
                        </t>
                    </tr>
                </t>
            </tbody>
        </xpath>
    </template>
</odoo>
